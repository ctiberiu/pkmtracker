<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pokédex Progress Tracker — Infinite + Compact + Clickable Pills</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --gap: 10px;
      --card-radius: 14px;
      --shadow: 0 4px 14px rgba(0,0,0,.08);
      --bg: #0b0d10;
      --panel: #12161b;
      --panel-2: #171d24;
      --text: #e9eef5;
      --muted: #a8b3c2;
      --accent: #67b3ff;
      /* Generation colors */
      --g1: #2e7d32;
      --g2: #1e88e5;
      --g3: #8e24aa;
      --g4: #f4511e;
      --g5: #6d4c41;
      --g6: #43a047;
      --g7: #00acc1;
      --g8: #3949ab;
      --g9: #c0ca33;
      --caught: #00e676;
      --uncaught: #ef5350;
      --caught-bg: #0f2a18; /* subtle dark green */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      background: linear-gradient(180deg, #0b0d10, #0e1318);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    header{
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(18,22,27,.98), rgba(18,22,27,.92));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid #1f2630;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px;}
    .controls{
      display: grid;
      grid-template-columns: 1fr 220px 180px 160px 180px 1fr;
      gap: var(--gap);
      align-items: center;
    }
    .controls > * { width: 100%; }
    .title{
      grid-column: 1 / -1;
      font-weight: 800; letter-spacing:.3px; font-size: 20px; margin-bottom: 6px;
      display:flex; align-items:center; gap:10px;
    }
    .title .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#1f2630; color:var(--muted)}
    input, select, button, .btn{
      background: var(--panel-2); color: var(--text);
      border: 1px solid #243041; border-radius: 10px; padding: 10px 12px;
      outline: none; box-shadow: var(--shadow);
    }
    input::placeholder{ color: #7f8da0; }
    button, .btn{ cursor: pointer; }
    .btn-ghost{ background: transparent; border-color: #2a3748;}
    .btn-outline{ background: transparent; border-color: var(--accent); color: var(--accent); }
    .btn-row{ display:flex; gap: var(--gap); justify-content:flex-end;}
    main{ padding: 12px 16px 60px; }
    .filters-bar{
      max-width:1200px;margin:8px auto 0; padding:0 16px;
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:#1f2630; color:var(--text); border:1px solid #2a3748;
    }
    .chip .x{ cursor:pointer; opacity:.7; }
    .grid{
      max-width: 1400px; margin: 8px auto 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: var(--gap);
    }
    .card{
      background: var(--panel);
      border: 1px solid #222b37;
      border-radius: var(--card-radius);
      overflow: hidden;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, opacity .12s ease, background .12s ease;
      position: relative;
    }
    .card:hover{ transform: translateY(-2px); border-color:#2f3a49; }
    .card .thumb{
      height: 120px; display:flex; align-items:center; justify-content:center;
      background: #0f141a; border-bottom:1px solid #1d2530;
      transition: height .12s ease;
    }
    /* Hide images mode: IMG display none + thumb height 40px */
    body.hide-images .card .thumb{ height: 40px; }
    body.hide-images .card .thumb img{ display:none; }
    .card .thumb img{ max-height: 110px; max-width: 90%; filter: drop-shadow(0 8px 10px rgba(0,0,0,.35)); }
    .meta{ padding: 10px 12px; display:grid; grid-template-columns: 1fr auto; gap:6px; align-items:center; }
    .name{ font-weight:800; letter-spacing:.2px; }
    .dex{ font-size:12px; color: var(--muted); }
    .types{ grid-column: 1 / -1; display:flex; flex-wrap: wrap; gap:6px; }
    .type{ font-size:11px; padding:3px 8px; border-radius:999px; background:#1e2530; border:1px solid #2b3748; text-transform: capitalize; cursor:pointer; }
    .gen-tag{
      position:absolute; top:8px; left:8px; font-size:11px; padding:3px 8px; border-radius:999px;
      font-weight:700; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.25);
      backdrop-filter: blur(2px);
      cursor: pointer;
    }
    .caught-dot{
      position:absolute; top:8px; right:8px; width:12px; height:12px; border-radius:999px; border:2px solid rgba(0,0,0,.35);
      background: var(--uncaught);
      box-shadow: 0 0 0 2px rgba(0,0,0,.15), 0 0 8px rgba(0,0,0,.2) inset;
    }
    .card.caught{
      opacity: 0.5;
      background: var(--caught-bg);
      border-color: color-mix(in oklab, var(--caught) 40%, #1f2b24);
    }
    .card.caught .caught-dot{ background: var(--caught); }
    /* Generation background accents */
    .g1  { box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--g1) 40%, transparent); }
    .g2  { box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--g2) 40%, transparent); }
    .g3  { box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--g3) 40%, transparent); }
    .g4  { box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--g4) 40%, transparent); }
    .g5  { box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--g5) 40%, transparent); }
    .g6  { box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--g6) 40%, transparent); }
    .g7  { box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--g7) 40%, transparent); }
    .g8  { box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--g8) 40%, transparent); }
    .g9  { box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--g9) 40%, transparent); }
    .footer-note{ text-align:center; color:var(--muted); margin-top:20px; font-size:12px; }
    .toolbar{ display:flex; gap: var(--gap); flex-wrap:wrap; }
    .toolbar .group{ display:flex; gap: var(--gap); align-items:center; }
    label.small{ font-size:12px; color: var(--muted); }
    .toggle-wrap{ display:flex; align-items:center; gap:8px; }
    .toggle-label{
      display:inline-flex; align-items:center; gap:8px;
      border-radius:10px; padding:10px 12px; border:1px solid #243041;
      background: var(--panel-2); color: var(--text);
      cursor:pointer; user-select:none;
    }
    .toggle-label.active{
      background: #ffffff; color:#111827; border-color:#d1d5db;
    }
    .toggle-label input{ display:none; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">Pokédex Progress Tracker <span class="badge">Gen 1–9</span></div>
      <div class="toolbar">
        <input id="search" type="text" placeholder="Search Pokémon..." />
        <div class="group">
          <label class="small" for="gen">Generation</label>
          <select id="gen">
            <option value="all" selected>All</option>
            <option value="1">Gen 1</option><option value="2">Gen 2</option><option value="3">Gen 3</option>
            <option value="4">Gen 4</option><option value="5">Gen 5</option><option value="6">Gen 6</option>
            <option value="7">Gen 7</option><option value="8">Gen 8</option><option value="9">Gen 9</option>
          </select>
        </div>
        <div class="group">
          <label class="small" for="type">Type</label>
          <select id="type">
            <option value="all" selected>All</option>
          </select>
        </div>
        <div class="group">
          <label class="small" for="caught">Caught</label>
          <select id="caught">
            <option value="all" selected>All</option>
            <option value="caught">Caught</option>
            <option value="uncaught">Uncaught</option>
          </select>
        </div>
        <div class="group toggle-wrap">
          <label id="hideImagesLabel" class="toggle-label" for="toggleImages">
            <input type="checkbox" id="toggleImages" />
            Hide images
          </label>
        </div>
        <div class="btn-row" style="margin-left:auto">
          <button class="btn-outline" id="export">Export</button>
          <label class="btn btn-ghost" for="importFile">Import</label>
          <input id="importFile" type="file" accept="application/json" style="display:none"/>
          <button id="reset" class="btn-ghost">Reset</button>
        </div>
      </div>
    </div>
  </header>

  <div class="filters-bar" id="activeFilters"></div>

  <main>
    <div class="grid" id="grid"></div>
    <div class="footer-note">Click a card to toggle <b>caught</b>. Click a <b>Gen</b> pill or <b>type</b> pill to filter. Data is local; use Export/Import to back up.</div>
  </main>

  <script>
    // --- Config & helpers ---
    const MAX_ID = 1025;
    const STORAGE_KEY = "dex_caught_v4";
    const INITIAL_BATCH = 100;
    const BATCH_SIZE = 100;

    const genRanges = [
      { gen:1, s:1,   e:151 },
      { gen:2, s:152, e:251 },
      { gen:3, s:252, e:386 },
      { gen:4, s:387, e:493 },
      { gen:5, s:494, e:649 },
      { gen:6, s:650, e:721 },
      { gen:7, s:722, e:809 },
      { gen:8, s:810, e:905 },
      { gen:9, s:906, e:1025 },
    ];
    const genById = (id)=>{
      for (const r of genRanges){ if (id>=r.s && id<=r.e) return r.gen; }
      return null;
    }
    const officialArtwork = (id) =>
      `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;

    const typeColors = {
      normal:"#A8A77A", fire:"#EE8130", water:"#6390F0", electric:"#F7D02C", grass:"#7AC74C",
      ice:"#96D9D6", fighting:"#C22E28", poison:"#A33EA1", ground:"#E2BF65", flying:"#A98FF3",
      psychic:"#F95587", bug:"#A6B91A", rock:"#B6A136", ghost:"#735797", dragon:"#6F35FC",
      dark:"#705746", steel:"#B7B7CE", fairy:"#D685AD"
    };

    // --- State ---
    let caught = loadCaught();
    let idToName = new Map();
    let idToTypes = new Map();
    let typeList = [];

    let filteredIds = [];
    let activeTypeFilters = new Set(); // multiple types (OR)
    let renderIndex = 0;
    const gridEl = document.getElementById("grid");
    const activeFiltersEl = document.getElementById("activeFilters");

    function loadCaught(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return new Set();
        const arr = JSON.parse(raw);
        return new Set(arr);
      }catch(e){ console.warn("Failed to load storage", e); return new Set(); }
    }
    function saveCaught(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(caught)));
      }catch(e){ console.warn("Failed to save storage", e); }
    }

    // --- Fetching data ---
    async function fetchAllNames(){
      const limit = 1100;
      const res = await fetch(`https://pokeapi.co/api/v2/pokemon?limit=${limit}`);
      const data = await res.json();
      const list = data.results || [];
      for(const p of list){
        const m = p.url.match(/\/pokemon\/(\d+)\/?$/);
        if(!m) continue;
        const id = parseInt(m[1], 10);
        if(id>=1 && id<=MAX_ID){
          let nm = p.name.replace(/-/g, ' ');
          nm = nm.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
          idToName.set(id, nm);
        }
      }
    }
    async function fetchAllTypes(){
      const res = await fetch("https://pokeapi.co/api/v2/type");
      const data = await res.json();
      const resources = (data.results || []).filter(t => !/(shadow|unknown)/i.test(t.name));
      for(const t of resources){
        try{
          const r = await fetch(t.url);
          const td = await r.json();
          const typeName = td.name;
          typeList.push(typeName);
          for(const rel of td.pokemon){
            const m = rel.pokemon.url.match(/\/pokemon\/(\d+)\/?$/);
            if(!m) continue;
            const id = parseInt(m[1], 10);
            if(id<1 || id>MAX_ID) continue;
            const arr = idToTypes.get(id) || [];
            if(!arr.includes(typeName)) arr.push(typeName);
            idToTypes.set(id, arr);
          }
        }catch(e){ console.warn("Type fetch failed", t.name, e); }
      }
      typeList.sort();
    }

    function populateTypeDropdown(){
      const sel = document.getElementById("type");
      while (sel.options.length > 1) sel.remove(1);
      for(const t of typeList){
        const opt = document.createElement("option");
        opt.value = t; opt.textContent = t[0].toUpperCase()+t.slice(1);
        sel.appendChild(opt);
      }
    }

    // --- Active Filters UI ---
    function renderActiveFiltersBar(){
      activeFiltersEl.innerHTML = "";
      // Gen filter chip if any
      const genVal = document.getElementById("gen").value;
      if(genVal !== "all"){
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.style.borderColor = "#39516a";
        chip.innerHTML = `Gen ${genVal} <span class="x" title="Remove">✕</span>`;
        chip.querySelector(".x").addEventListener("click", ()=>{
          document.getElementById("gen").value = "all";
          resetAndRender();
        });
        activeFiltersEl.appendChild(chip);
      }
      // Type chips
      for(const t of activeTypeFilters){
        const chip = document.createElement("span");
        chip.className = "chip";
        const color = typeColors[t] || "#2b3748";
        chip.style.borderColor = color;
        chip.innerHTML = `${t[0].toUpperCase()+t.slice(1)} <span class="x" title="Remove">✕</span>`;
        chip.querySelector(".x").addEventListener("click", ()=>{
          activeTypeFilters.delete(t);
          resetAndRender();
        });
        activeFiltersEl.appendChild(chip);
      }
    }

    // --- Card creation ---
    function buildCard(id){
      const name = idToName.get(id);
      const types = idToTypes.get(id) || [];
      const gen = genById(id);
      const card = document.createElement("div");
      card.className = `card g${gen} ${caught.has(id) ? "caught" : ""}`;
      card.dataset.id = id;
      card.title = "Click to toggle caught";
      card.innerHTML = `
        <span class="gen-tag" data-gen="${gen}">Gen ${gen}</span>
        <span class="caught-dot"></span>
        <div class="thumb"><img loading="lazy" src="${officialArtwork(id)}" alt="${name}"></div>
        <div class="meta">
          <div class="name">${name}</div>
          <div class="dex">#${String(id).padStart(3,'0')}</div>
          <div class="types">
            ${types.map(t=>`<span class="type" data-type="${t}" style="background:${typeColors[t]||'#263141'}22;border-color:${typeColors[t]||'#2b3748'}">${t}</span>`).join('')}
          </div>
        </div>
      `;
      // Toggle caught on card click
      card.addEventListener("click", () => {
        if(caught.has(id)) caught.delete(id); else caught.add(id);
        saveCaught();
        card.classList.toggle("caught");
      });
      // Click gen pill to filter by gen
      card.querySelector(".gen-tag").addEventListener("click", (e)=>{
        e.stopPropagation();
        const g = String(gen);
        const genSel = document.getElementById("gen");
        genSel.value = g;
        resetAndRender();
      });
      // Click type pills to add to active types (OR)
      card.querySelectorAll(".type").forEach(el=>{
        el.addEventListener("click", (e)=>{
          e.stopPropagation();
          const t = el.dataset.type;
          activeTypeFilters.add(t);
          // Sync dropdown to "all" since multiple chips may be used
          document.getElementById("type").value = "all";
          resetAndRender();
        });
      });
      return card;
    }

    // --- Filtering + rendering ---
    function computeFilteredIds(){
      const q = document.getElementById("search").value.trim().toLowerCase();
      const genFilter = document.getElementById("gen").value;
      const dropdownType = document.getElementById("type").value;
      const caughtFilter = document.getElementById("caught").value;

      const ids = Array.from(idToName.keys()).sort((a,b)=>a-b);
      const out = [];
      for(const id of ids){
        const name = idToName.get(id);
        const types = idToTypes.get(id) || [];
        const gen = genById(id);
        if(!gen) continue;

        if(q && !name.toLowerCase().includes(q)) continue;
        if(genFilter !== "all" && gen.toString() !== genFilter) continue;

        // Type logic: either dropdown single, or activeTypeFilters (OR)
        if(dropdownType !== "all"){
          if(!types.includes(dropdownType)) continue;
        } else if(activeTypeFilters.size > 0){
          let hasAny = false;
          for(const t of activeTypeFilters){ if(types.includes(t)) { hasAny = true; break; } }
          if(!hasAny) continue;
        }

        if(caughtFilter === "caught" && !caught.has(id)) continue;
        if(caughtFilter === "uncaught" && caught.has(id)) continue;

        out.push(id);
      }
      return out;
    }

    function resetAndRender(){
      filteredIds = computeFilteredIds();
      renderIndex = 0;
      gridEl.innerHTML = "";
      renderActiveFiltersBar();
      appendNextBatch(INITIAL_BATCH);
    }

    function appendNextBatch(batchSize = BATCH_SIZE){
      if(renderIndex >= filteredIds.length) return;
      const to = Math.min(renderIndex + batchSize, filteredIds.length);
      const frag = document.createDocumentFragment();
      for(let i=renderIndex; i<to; i++){
        frag.appendChild(buildCard(filteredIds[i]));
      }
      gridEl.appendChild(frag);
      renderIndex = to;
    }

    function onScrollLoadMore(){
      const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 800;
      if(nearBottom){
        appendNextBatch();
      }
    }

    // --- Export / Import / Reset ---
    document.getElementById("export").addEventListener("click", () => {
      const payload = {
        version: 4,
        createdAt: new Date().toISOString(),
        caught: Array.from(caught)
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "pokedex-progress.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });
    document.getElementById("importFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        const arr = Array.isArray(data) ? data : data.caught;
        if(Array.isArray(arr)){
          caught = new Set(arr.map(x=>parseInt(x,10)).filter(x=>x>=1 && x<=MAX_ID));
          saveCaught();
          resetAndRender();
        }else{
          alert("Invalid file format.");
        }
      }catch(err){
        console.error(err);
        alert("Failed to import file.");
      }finally{
        e.target.value = "";
      }
    });
    document.getElementById("reset").addEventListener("click", () => {
      if(confirm("Reset caught progress? This clears local data.")){
        localStorage.removeItem(STORAGE_KEY);
        caught = new Set();
        resetAndRender();
      }
    });

    // --- Filters listeners ---
    document.getElementById("search").addEventListener("input", resetAndRender);
    document.getElementById("gen").addEventListener("change", resetAndRender);
    document.getElementById("type").addEventListener("change", (e)=>{
      // If user picks a type from dropdown, clear active type chips and apply single choice
      activeTypeFilters.clear();
      resetAndRender();
    });
    document.getElementById("caught").addEventListener("change", resetAndRender);

    // Hide images toggle styling + behavior
    const toggle = document.getElementById("toggleImages");
    const toggleLabel = document.getElementById("hideImagesLabel");
    toggle.addEventListener("change", ()=>{
      const active = toggle.checked;
      document.body.classList.toggle("hide-images", active);
      toggleLabel.classList.toggle("active", active);
    });

    window.addEventListener("scroll", onScrollLoadMore, { passive: true });

    // --- Init ---
    async function init(){
      await fetchAllNames();
      await fetchAllTypes();
      populateTypeDropdown();
      resetAndRender();
    }
    init();
  </script>
</body>
</html>
